<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GlobalMeet AI - Dual Chat</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome & Google Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- React Imports -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- PeerJS -->
    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>

    <style>
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #000000;
            color: #ffffff;
            overflow: hidden;
        }
        
        /* Premium Glass Effect */
        .glass-panel {
            background: rgba(20, 20, 20, 0.75);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }
        
        .glass-dock {
            background: rgba(10, 10, 10, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
        }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(2); opacity: 0; }
        }
        
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        .animate-slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        
        .visualizer-bar {
            width: 4px; background: #3b82f6; border-radius: 2px;
            animation: equalize 0.5s infinite ease-in-out;
        }
        .visualizer-bar:nth-child(1) { animation-delay: -0.4s; height: 10px; }
        .visualizer-bar:nth-child(2) { animation-delay: -0.2s; height: 16px; }
        .visualizer-bar:nth-child(3) { animation-delay: -0.5s; height: 12px; }
        @keyframes equalize { 0%, 100% { transform: scaleY(1); opacity: 0.7; } 50% { transform: scaleY(1.5); opacity: 1; } }

        /* Input Fields */
        .otp-input {
            width: 3rem; height: 3.5rem; font-size: 1.5rem; text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 0.75rem;
            background-color: rgba(255, 255, 255, 0.05); color: #ffffff; font-weight: 600;
            transition: all 0.2s;
        }
        .otp-input:focus {
            border-color: #3b82f6; background-color: rgba(59, 130, 246, 0.1); outline: none; transform: translateY(-2px);
        }
        
        /* Chat Bubbles */
        .bubble-me { 
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); 
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.2);
        }
        .bubble-other { 
            background: rgba(40, 40, 40, 0.8); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(8px); 
        }

        /* Scrollbar */
        .custom-scroll { scroll-behavior: smooth; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }

        /* Split View Helper */
        .split-header {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: rgba(255, 255, 255, 0.5);
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="text-white h-screen w-screen overflow-hidden bg-black">
    
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useCallback } from 'react';
        import ReactDOM from 'react-dom/client';

        const APP_PREFIX = "GM-V3-";

        const LANGUAGES = [
            { code: 'ko', name: 'ÌïúÍµ≠Ïñ¥', flag: 'üá∞üá∑' },
            { code: 'en', name: 'English', flag: 'üá∫üá∏' },
            { code: 'ja', name: 'Êó•Êú¨Ë™û', flag: 'üáØüáµ' },
            { code: 'zh', name: '‰∏≠Êñá', flag: 'üá®üá≥' }
        ];

        // --- Mock Translation (API Key ÏóÜÏùÑ Îïå) ---
        const mockTranslate = async (text, targetLang) => {
            return new Promise((resolve) => {
                setTimeout(() => {
                    let translated = text;
                    // [ÏàòÏ†ï] ÌÇ§Í∞Ä ÏóÜÏñ¥ÎèÑ Îç∞Î™®Ïö© Î≤àÏó≠ Í≤∞Í≥º Î∞òÌôò (ÌÖåÏä§Ìä∏Ïö©)
                    if (targetLang === 'en') {
                         if (/[Í∞Ä-Ìû£]/.test(text)) {
                             translated = `[Demo] Translated: ${text}`;
                             if (text.includes("ÏïàÎÖï")) translated = "Hello.";
                             if (text.includes("Î∞òÍ∞Ä")) translated = "Nice to meet you.";
                             if (text.includes("Í∞êÏÇ¨")) translated = "Thank you.";
                         }
                    } else if (targetLang === 'ko') {
                        if (/[a-zA-Z]/.test(text)) {
                             translated = `[Îç∞Î™®] Î≤àÏó≠Îê®: ${text}`;
                             if (text.toLowerCase().includes("hello")) translated = "ÏïàÎÖïÌïòÏÑ∏Ïöî.";
                             if (text.toLowerCase().includes("thank")) translated = "Í∞êÏÇ¨Ìï©ÎãàÎã§.";
                        }
                    }
                    resolve(translated); 
                }, 300);
            });
        };

        function App() {
            const [mode, setMode] = useState('home');
            const [roomCode, setRoomCode] = useState(['', '', '', '', '', '']); 
            const [generatedCode, setGeneratedCode] = useState('');
            const [status, setStatus] = useState('');
            const [isHost, setIsHost] = useState(false);
            
            // Media
            const [mediaType, setMediaType] = useState('video'); 
            const [localStream, setLocalStream] = useState(null);
            const [remoteStream, setRemoteStream] = useState(null);
            const [remoteMediaType, setRemoteMediaType] = useState('unknown');
            const [subtitles, setSubtitles] = useState([]); 
            const [myLang, setMyLang] = useState('ko');
            const [targetLang, setTargetLang] = useState('en');

            const [showSettings, setShowSettings] = useState(false);
            const [geminiKey, setGeminiKey] = useState('');
            const [isAudioActive, setIsAudioActive] = useState(false);
            const [interimText, setInterimText] = useState(''); 
            
            // [Ï∂îÍ∞Ä] UI Layout State
            const [isSidebarOpen, setIsSidebarOpen] = useState(true); // Í∏∞Î≥∏Ï†ÅÏúºÎ°ú Ïó¥Î¶º

            const localVideoRef = useRef(null);
            const remoteVideoRef = useRef(null);
            const remoteAudioRef = useRef(null);
            const peerRef = useRef(null);
            const connRef = useRef(null);
            const callRef = useRef(null);
            const recognitionRef = useRef(null);
            const geminiKeyRef = useRef('');
            const inputRefs = useRef([]);
            
            // Ïä§ÌÅ¨Î°§Ïö© Ref 2Í∞ú (ÏÉÅÎåÄÎ∞©Ïö©, ÎÇòÏö©)
            const partnerChatEndRef = useRef(null);
            const myChatEndRef = useRef(null);

            useEffect(() => {
                const savedKey = localStorage.getItem('gemini_api_key');
                if (savedKey) { setGeminiKey(savedKey); geminiKeyRef.current = savedKey; }
            }, []);

            // Auto-scroll logic enhanced (Í∞ÅÍ∞Å Ïä§ÌÅ¨Î°§)
            useEffect(() => {
                if (partnerChatEndRef.current) partnerChatEndRef.current.scrollIntoView({ behavior: 'smooth' });
                if (myChatEndRef.current) myChatEndRef.current.scrollIntoView({ behavior: 'smooth' });
            }, [subtitles, interimText, isSidebarOpen]);

            // Audio Level
            useEffect(() => {
                if (!localStream && !remoteStream) return;
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                const audioContext = new AudioContext();
                const analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                const dataArray = new Uint8Array(analyser.frequencyBinCount);
                const sources = [];
                try {
                    if (localStream && localStream.getAudioTracks().length > 0) {
                        const source = audioContext.createMediaStreamSource(localStream);
                        source.connect(analyser); sources.push(source);
                    }
                    if (remoteStream && remoteStream.getAudioTracks().length > 0) {
                        const source = audioContext.createMediaStreamSource(remoteStream);
                        source.connect(analyser); sources.push(source);
                    }
                } catch (e) {}

                let animationId;
                const checkVolume = () => {
                    analyser.getByteFrequencyData(dataArray);
                    let sum = 0;
                    for (let i = 0; i < dataArray.length; i++) sum += dataArray[i];
                    setIsAudioActive(sum / dataArray.length > 10);
                    animationId = requestAnimationFrame(checkVolume);
                };
                if (sources.length > 0) checkVolume();
                return () => {
                    cancelAnimationFrame(animationId);
                    sources.forEach(s => s.disconnect());
                    analyser.disconnect();
                    if (audioContext.state !== 'closed') audioContext.close();
                };
            }, [localStream, remoteStream]);

            const getMediaStream = async () => {
                try {
                    setStatus("Ïπ¥Î©îÎùº Ïó∞Í≤∞ Ï§ë...");
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    setMediaType('video');
                    return stream;
                } catch (err) {
                    try {
                        const audioStream = await navigator.mediaDevices.getUserMedia({ video: false, audio: true });
                        setMediaType('audio');
                        setStatus("Ïò§ÎîîÏò§ Î™®Îìú");
                        return audioStream;
                    } catch (err2) {
                        setMediaType('text');
                        setStatus("ÌÖçÏä§Ìä∏ Î™®Îìú");
                        return null;
                    }
                }
            };

            const createRoom = async () => {
                const code = Math.floor(100000 + Math.random() * 900000).toString();
                setGeneratedCode(code);
                setIsHost(true);
                setMode('host');
                initPeer(code);
            };

            const joinRoom = async () => {
                const code = roomCode.join('');
                if (code.length !== 6) return alert("6ÏûêÎ¶¨ ÏΩîÎìúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.");
                setIsHost(false);
                setMode('join_connecting');
                const peer = new Peer({ debug: 1 });
                peerRef.current = peer;
                peer.on('open', () => { setStatus("Ìò∏Ïä§Ìä∏ Ïó∞Í≤∞ Ï§ë..."); connectToHost(peer, code); });
                peer.on('error', handlePeerError);
            };

            const initPeer = (code) => {
                if (peerRef.current) peerRef.current.destroy();
                const peer = new Peer(`${APP_PREFIX}${code}`, { debug: 1 });
                peer.on('open', () => setStatus("Ï∞∏Ïó¨Ïûê ÎåÄÍ∏∞ Ï§ë..."));
                peer.on('connection', (conn) => setupDataConnection(conn));
                peer.on('call', (call) => { setStatus("Ïó∞Í≤∞ ÏàòÏã†..."); answerCall(call); });
                peer.on('error', handlePeerError);
                peerRef.current = peer;
            };

            const handlePeerError = (err) => {
                if (err.type === 'peer-unavailable') { alert("Î∞©ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§."); setMode('home'); }
                else setStatus(`Ïò§Î•ò: ${err.type}`);
            };

            const connectToHost = async (peer, hostCode) => {
                const hostId = `${APP_PREFIX}${hostCode}`;
                const conn = peer.connect(hostId);
                conn.on('open', () => { setStatus("Îç∞Ïù¥ÌÑ∞ Ïó∞Í≤∞Îê®"); setupDataConnection(conn); });
                const stream = await getMediaStream();
                setLocalStream(stream);
                setMode('call');
                if (stream) {
                    const call = peer.call(hostId, stream);
                    setupCallEvents(call);
                } else {
                    setStatus("ÌÖçÏä§Ìä∏ Î™®Îìú Ïó∞Í≤∞");
                    setupSpeechRecognition(); 
                }
            };

            const answerCall = async (call) => {
                const stream = await getMediaStream();
                setLocalStream(stream);
                if (stream) call.answer(stream); else call.answer(); 
                setupCallEvents(call);
                setMode('call');
            };

            const setupCallEvents = (call) => {
                callRef.current = call;
                call.on('stream', (rs) => {
                    setRemoteStream(rs);
                    setRemoteMediaType(rs.getVideoTracks().length > 0 ? 'video' : 'audio');
                    setStatus("Ïó∞Í≤∞Îê®");
                });
                setupSpeechRecognition(); 
            };

            const setupDataConnection = (conn) => {
                connRef.current = conn;
                conn.on('data', async (data) => {
                    if (data.type === 'subtitle') {
                        // ÏàòÏã†: ÏÉÅÎåÄÎ∞© Ïñ∏Ïñ¥ -> ÎÇ¥ Ïñ∏Ïñ¥ Î≤àÏó≠
                        const translated = await translateWithGemini(data.text, myLang);
                        setSubtitles(prev => [...prev, { id: Date.now(), text: data.text, translated, isLocal: false }]);
                        speak(translated, myLang);
                    }
                });
                conn.on('open', () => { if (mode !== 'call') setStatus("Ï§ÄÎπÑ ÏôÑÎ£å"); });
            };

            // --- STT & AI ---
            const setupSpeechRecognition = () => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) return;
                if (recognitionRef.current) return;

                const recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true; 
                recognition.lang = myLang === 'ko' ? 'ko-KR' : (myLang === 'en' ? 'en-US' : (myLang === 'ja' ? 'ja-JP' : 'zh-CN'));

                recognition.onresult = async (event) => {
                    let final = '';
                    let interim = '';
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) final += event.results[i][0].transcript;
                        else interim += event.results[i][0].transcript;
                    }
                    setInterimText(interim);
                    if (final.trim()) {
                        setInterimText(''); 
                        if (connRef.current?.open) connRef.current.send({ type: 'subtitle', text: final });
                        
                        // Î∞úÏã†: ÎÇ¥ Ïñ∏Ïñ¥ -> ÏÉÅÎåÄÎ∞© Ïñ∏Ïñ¥ Î≤àÏó≠
                        const myTrans = await translateWithGemini(final, targetLang);
                        setSubtitles(prev => [...prev, { id: Date.now(), text: final, translated: myTrans, isLocal: true }]);
                    }
                };

                recognition.onend = () => {
                    if (mode === 'call') setTimeout(() => { try { recognition.start(); } catch(e) {} }, 500);
                };

                try { recognition.start(); recognitionRef.current = recognition; } catch (e) {}
            };

            const translateWithGemini = async (text, tLang) => {
                const apiKey = geminiKeyRef.current;
                
                // [ÏàòÏ†ï] ÌÇ§Í∞Ä ÏóÜÏúºÎ©¥ Îç∞Î™®Ïö© Î≤àÏó≠ Î∞òÌôò (ÏõêÎ¨∏X)
                if (!apiKey) return mockTranslate(text, tLang); 
                
                const langMap = { 'ko': 'Korean', 'en': 'English', 'ja': 'Japanese', 'zh': 'Chinese' };
                const target = langMap[tLang] || 'English';
                const prompt = `You are a professional interpreter. Translate the following text to ${target}.
IMPORTANT: Output ONLY the translated text without any explanation or quotes.
Text: "${text}"`;
                
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await res.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || text;
                } catch (e) { return text; }
            };

            const speak = (text, lang) => {
                if (!window.speechSynthesis) return;
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                const voiceLangMap = { 'ko': 'ko-KR', 'en': 'en-US', 'ja': 'ja-JP', 'zh': 'zh-CN' };
                u.lang = voiceLangMap[lang] || 'en-US';
                u.rate = 1.1; 
                window.speechSynthesis.speak(u);
            };

            // UI Helpers
            const handleOtpChange = (index, value) => {
                if (isNaN(value)) return;
                const newCode = [...roomCode];
                newCode[index] = value.substring(value.length - 1);
                setRoomCode(newCode);
                if (value && index < 5) inputRefs.current[index + 1].focus();
            };
            const handleKeyDown = (i, e) => { if (e.key === 'Backspace' && !roomCode[i] && i > 0) inputRefs.current[i - 1].focus(); };
            const saveSettings = (e) => {
                e.preventDefault();
                const key = new FormData(e.target).get('apiKey');
                localStorage.setItem('gemini_api_key', key);
                setGeminiKey(key);
                geminiKeyRef.current = key;
                setShowSettings(false);
            };
            const swapLanguages = () => {
                const temp = myLang; setMyLang(targetLang); setTargetLang(temp);
            };

            useEffect(() => {
                if (localStream && localVideoRef.current) localVideoRef.current.srcObject = localStream;
                if (remoteStream && remoteVideoRef.current) remoteVideoRef.current.srcObject = remoteStream;
                if (remoteStream && remoteAudioRef.current) {
                    remoteAudioRef.current.srcObject = remoteStream;
                    remoteAudioRef.current.play().catch(console.error);
                }
            }, [localStream, remoteStream, mode]);

            // --- Render ---
            if (mode === 'home') return (
                <div className="min-h-screen flex items-center justify-center p-6 relative">
                    <div className="absolute inset-0 bg-black/50 pointer-events-none"></div>
                    <div className="glass-card max-w-md w-full rounded-[2rem] p-10 text-center animate-enter relative z-10">
                        <button onClick={() => setShowSettings(true)} className="absolute top-6 right-6 text-slate-400 hover:text-white transition-colors">
                            <i className="fas fa-cog text-xl"></i>
                        </button>
                        
                        <div className="mb-8">
                            <div className="w-20 h-20 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-3xl mx-auto flex items-center justify-center text-white text-3xl shadow-2xl mb-6"><i className="fas fa-globe-americas"></i></div>
                            <h1 className="text-3xl font-bold tracking-tight mb-2">GlobalMeet</h1>
                            <p className="text-slate-400 text-sm">Ï¥àÍ≥†ÏÜç Ïã§ÏãúÍ∞Ñ ÌÜµÏó≠</p>
                        </div>

                        <div className="bg-white/5 rounded-2xl p-4 mb-6 border border-white/10">
                            <p className="text-xs font-bold text-slate-500 mb-3 uppercase tracking-wider">Ïñ∏Ïñ¥ ÏÑ§Ï†ï</p>
                            <div className="flex items-center justify-between gap-2">
                                <div className="flex-1">
                                    <span className="text-xs text-slate-400 block mb-1">ÎÇò (Me)</span>
                                    <select value={myLang} onChange={(e) => setMyLang(e.target.value)} className="w-full bg-black/30 border border-white/10 rounded-lg p-2 text-sm focus:outline-none text-center cursor-pointer">
                                        {LANGUAGES.map(l => <option key={l.code} value={l.code}>{l.flag} {l.name}</option>)}
                                    </select>
                                </div>
                                <button onClick={swapLanguages} className="p-2 text-slate-500 hover:text-white transition mt-4"><i className="fas fa-exchange-alt"></i></button>
                                <div className="flex-1">
                                    <span className="text-xs text-slate-400 block mb-1">ÏÉÅÎåÄÎ∞© (Partner)</span>
                                    <select value={targetLang} onChange={(e) => setTargetLang(e.target.value)} className="w-full bg-black/30 border border-white/10 rounded-lg p-2 text-sm focus:outline-none text-center cursor-pointer">
                                        {LANGUAGES.map(l => <option key={l.code} value={l.code}>{l.flag} {l.name}</option>)}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div className="space-y-6">
                            <button onClick={createRoom} className="w-full py-4 bg-white text-black rounded-2xl font-bold text-lg shadow-xl hover:bg-slate-100 flex items-center justify-center gap-3"><i className="fas fa-plus-circle text-blue-600"></i> ÌöåÏùò ÏãúÏûëÌïòÍ∏∞</button>
                            <div className="relative py-2"><div className="absolute inset-0 flex items-center"><div className="w-full border-t border-white/10"></div></div><div className="relative flex justify-center text-xs uppercase font-semibold text-slate-500"><span className="bg-[#191919] px-2">ÎòêÎäî</span></div></div>
                            <div className="space-y-4">
                                <p className="text-sm font-medium text-slate-400">Ï∞∏Ïó¨ ÏΩîÎìú ÏûÖÎ†•</p>
                                <div className="flex justify-between gap-2">
                                    {roomCode.map((d, i) => <input key={i} ref={el => inputRefs.current[i] = el} type="text" maxLength="1" value={d} onChange={e => handleOtpChange(i, e.target.value)} onKeyDown={e => handleKeyDown(i, e)} className="otp-input" />)}
                                </div>
                                <button onClick={joinRoom} className="w-full py-3.5 bg-slate-800/80 hover:bg-slate-700 text-white rounded-2xl font-semibold border border-white/10">ÏûÖÏû•ÌïòÍ∏∞</button>
                            </div>
                        </div>
                        
                        {showSettings && (
                            <div className="absolute inset-0 bg-black/90 backdrop-blur-xl rounded-[2rem] z-50 flex flex-col items-center justify-center p-8 animate-enter">
                                <h3 className="text-xl font-bold mb-6">API ÏÑ§Ï†ï</h3>
                                <form onSubmit={saveSettings} className="w-full space-y-4">
                                    <input name="apiKey" defaultValue={geminiKey} placeholder="Gemini API Key" className="w-full p-4 border border-white/10 rounded-2xl bg-white/5 text-white placeholder-slate-600 focus:border-blue-500 focus:outline-none" />
                                    <div className="flex gap-3 pt-2">
                                        <button type="button" onClick={() => setShowSettings(false)} className="flex-1 py-3 bg-slate-800 rounded-xl font-bold text-slate-300">Ï∑®ÏÜå</button>
                                        <button type="submit" className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold">Ï†ÄÏû•</button>
                                    </div>
                                </form>
                            </div>
                        )}
                    </div>
                </div>
            );

            if (mode === 'host') return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="glass-card max-w-md w-full rounded-[2rem] p-10 text-center animate-enter">
                        <div className="mb-4">
                            <span className="text-sm text-slate-400 block mb-1">ÌÜµÏó≠ ÏÑ§Ï†ï</span>
                            <div className="flex justify-center gap-2 text-lg font-bold">
                                {LANGUAGES.find(l=>l.code===myLang)?.flag} 
                                <i className="fas fa-arrow-right text-slate-500 mx-2 text-sm"></i> 
                                {LANGUAGES.find(l=>l.code===targetLang)?.flag}
                            </div>
                        </div>
                        <h2 className="text-xl font-bold text-white mb-1">Ï∞∏Ïó¨ ÏΩîÎìú</h2>
                        <div className="bg-white/5 border border-white/10 rounded-2xl p-6 mb-8 relative cursor-pointer" onClick={() => {navigator.clipboard.writeText(generatedCode); alert('Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§');}}>
                            <div className="text-5xl font-mono font-bold tracking-widest text-white">{generatedCode.slice(0,3)} {generatedCode.slice(3)}</div>
                        </div>
                        <div className="flex items-center justify-center gap-3 text-sm text-slate-400 mb-8"><div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>{status}</div>
                        <button onClick={() => window.location.reload()} className="text-slate-500 text-sm font-medium hover:text-red-400">Ï∑®ÏÜå</button>
                    </div>
                </div>
            );

            if (mode === 'join_connecting') return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="glass-card max-w-sm w-full rounded-[2rem] p-10 text-center animate-enter">
                        <div className="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                        <h2 className="text-xl font-bold mb-2">Ïó∞Í≤∞ Ï§ë...</h2>
                        <p className="text-slate-400 text-sm">{status}</p>
                    </div>
                </div>
            );

            // --- Main Call Screen ---
            const isVideoMode = mediaType === 'video' && remoteMediaType === 'video' && remoteStream;
            
            // [ÏàòÏ†ï] 2Í∞úÎ°ú Î∂ÑÎ¶¨Îêú ÎåÄÌôî Îç∞Ïù¥ÌÑ∞ ÌïÑÌÑ∞ÎßÅ
            const partnerSubtitles = subtitles.filter(s => !s.isLocal);
            const mySubtitles = subtitles.filter(s => s.isLocal);

            return (
                <div className="relative h-full w-full bg-black overflow-hidden flex flex-col md:flex-row">
                    
                    {/* Main Content (Video/Audio) */}
                    <div className={`relative flex-1 bg-black flex items-center justify-center overflow-hidden transition-all duration-300 ${isSidebarOpen ? 'md:mr-[400px]' : ''}`}>
                        
                        {!isVideoMode && remoteStream && <audio ref={remoteAudioRef} autoPlay playsInline controls={false} style={{ display: 'none' }} />}
                        
                        {isVideoMode ? (
                            <video ref={remoteVideoRef} autoPlay playsInline className="w-full h-full object-contain" />
                        ) : (
                            <div className="flex flex-col items-center justify-center opacity-50">
                                <div className="w-32 h-32 bg-slate-800 rounded-full flex items-center justify-center mb-4"><i className="fas fa-user text-5xl text-slate-500"></i></div>
                                <p className="text-lg font-light text-slate-300">{status}</p>
                            </div>
                        )}

                        {isVideoMode && (
                            <div className="absolute top-6 right-6 w-48 aspect-[3/4] sm:aspect-video bg-black rounded-2xl overflow-hidden shadow-2xl border border-white/20 z-30 group">
                                {localStream ? <video ref={localVideoRef} autoPlay playsInline muted className="w-full h-full object-cover transform scale-x-[-1]" /> : null}
                            </div>
                        )}
                    </div>

                    {/* [ÏàòÏ†ï] 2Îã® Î∂ÑÎ¶¨Îêú Ï±ÑÌåÖ ÏÇ¨Ïù¥ÎìúÎ∞î */}
                    <div className={`fixed inset-y-0 right-0 w-full md:w-[400px] bg-gray-900/95 backdrop-blur-xl border-l border-white/10 transform transition-transform duration-300 z-50 flex flex-col ${isSidebarOpen ? 'translate-x-0' : 'translate-x-full'}`}>
                        
                        {/* Header */}
                        <div className="p-4 border-b border-white/10 flex justify-between items-center bg-white/5 shrink-0">
                            <h3 className="font-bold text-lg flex items-center gap-2">
                                <i className="far fa-comments text-blue-400"></i> Ïã§ÏãúÍ∞Ñ ÎåÄÌôî
                            </h3>
                            <button onClick={() => setIsSidebarOpen(false)} className="md:hidden text-slate-400 p-2"><i className="fas fa-times"></i></button>
                        </div>

                        {/* Top Half: Partner (ÏÉÅÎåÄÎ∞©) */}
                        <div className="flex-1 flex flex-col border-b border-white/10 overflow-hidden relative bg-slate-800/30">
                            <div className="split-header flex justify-between items-center">
                                <span><i className="fas fa-user mr-2 text-yellow-400"></i> ÏÉÅÎåÄÎ∞© (Partner)</span>
                                <span className="text-[10px] text-slate-400">{LANGUAGES.find(l=>l.code===targetLang)?.name}</span>
                            </div>
                            <div className="flex-1 overflow-y-auto custom-scroll p-4 space-y-3">
                                {partnerSubtitles.length === 0 && <div className="text-center text-slate-600 text-sm mt-10">ÏÉÅÎåÄÎ∞©Ïùò ÎßêÏù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§</div>}
                                {partnerSubtitles.map(sub => (
                                    <div key={sub.id} className="flex flex-col items-start animate-slide-up">
                                        <div className="bg-slate-700/80 border border-slate-600 text-white px-4 py-3 rounded-2xl rounded-tl-none shadow-sm max-w-[95%]">
                                            <div className="text-lg font-bold text-yellow-300 leading-snug">{sub.translated}</div>
                                            <div className="text-xs text-slate-400 border-t border-slate-600 pt-2 mt-1">{sub.text}</div>
                                        </div>
                                    </div>
                                ))}
                                <div ref={partnerChatEndRef} />
                            </div>
                        </div>

                        {/* Bottom Half: Me (ÎÇò) */}
                        <div className="flex-1 flex flex-col overflow-hidden bg-slate-900/50">
                            <div className="split-header flex justify-between items-center">
                                <span><i className="fas fa-user mr-2 text-blue-400"></i> ÎÇò (Me)</span>
                                <span className="text-[10px] text-slate-400">{LANGUAGES.find(l=>l.code===myLang)?.name}</span>
                            </div>
                            <div className="flex-1 overflow-y-auto custom-scroll p-4 space-y-3">
                                {mySubtitles.length === 0 && <div className="text-center text-slate-600 text-sm mt-10">ÎÇ¥Í∞Ä Ìïú ÎßêÏù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§</div>}
                                {mySubtitles.map(sub => (
                                    <div key={sub.id} className="flex flex-col items-end animate-slide-up">
                                        <div className="bubble-me text-white px-4 py-3 rounded-2xl rounded-tr-none shadow-sm max-w-[95%] text-right">
                                            <div className="text-base font-medium">{sub.text}</div>
                                            <div className="text-xs text-blue-200 border-t border-blue-500/50 pt-1 mt-1 flex items-center justify-end gap-1.5">
                                                <span>{sub.translated}</span> <i className="fas fa-check text-[10px]"></i>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                                <div ref={myChatEndRef} />
                            </div>

                            {/* Bottom Input Area (Inside Me section) */}
                            <div className="p-3 bg-white/5 border-t border-white/10 shrink-0">
                                <div className="flex flex-col gap-2">
                                    <div className="h-10 flex items-center justify-center text-center px-4 bg-black/40 rounded-xl border border-white/5 relative overflow-hidden">
                                        {interimText ? (
                                            <span className="text-blue-300 text-sm animate-pulse truncate w-full">{interimText}</span>
                                        ) : (
                                            <div className="flex items-center gap-2 text-slate-500 text-xs">
                                                <div className={`w-2 h-2 rounded-full ${isAudioActive ? 'bg-green-500 animate-pulse' : 'bg-slate-600'}`}></div>
                                                <span>Îì£Í≥† ÏûàÏäµÎãàÎã§...</span>
                                            </div>
                                        )}
                                        {isAudioActive && (
                                            <div className="absolute right-3 top-1/2 -translate-y-1/2 flex gap-0.5 h-4 items-end opacity-50">
                                                <div className="w-1 bg-blue-500 visualizer-bar"></div>
                                                <div className="w-1 bg-blue-500 visualizer-bar" style={{animationDelay:'-0.2s'}}></div>
                                                <div className="w-1 bg-blue-500 visualizer-bar" style={{animationDelay:'-0.4s'}}></div>
                                            </div>
                                        )}
                                    </div>
                                    <div className="flex justify-between items-center px-1">
                                        <button onClick={() => window.location.reload()} className="w-8 h-8 rounded-full bg-red-600 hover:bg-red-500 text-white flex items-center justify-center transition shadow-lg">
                                            <i className="fas fa-phone-slash text-xs"></i>
                                        </button>
                                        <span className="text-[10px] text-slate-600">GlobalMeet AI</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {!isSidebarOpen && (
                        <button 
                            onClick={() => setIsSidebarOpen(true)}
                            className="absolute bottom-8 right-8 w-14 h-14 bg-blue-600 hover:bg-blue-500 text-white rounded-full shadow-2xl flex items-center justify-center z-50 transition-transform hover:scale-110"
                        >
                            <i className="fas fa-columns text-xl"></i>
                            {subtitles.length > 0 && <span className="absolute top-0 right-0 w-4 h-4 bg-red-500 rounded-full border-2 border-black"></span>}
                        </button>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
